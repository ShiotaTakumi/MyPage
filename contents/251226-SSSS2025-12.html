<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åˆ†é€Ÿ a_i ã§æ³¨ãŒã‚Œã‚‹ã‚³ãƒƒãƒ—å¯è¦–åŒ–ï¼ˆå³å¯†è¨ˆç®—ï¼‰</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121a24;
      --panel2:#0f1620;
      --text:#e8eef7;
      --muted:#a9b6c8;
      --accent:#67c5ff;
      --warn:#ff6b6b;
      --ok:#8bffb0;
      --line:#223047;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
      --waterTrans: .25s;
    }

    *{ box-sizing: border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 10%, #162235 0%, var(--bg) 55%, #070a0f 100%);
      color: var(--text);
    }

    header{
      padding: 18px 18px 10px 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    header h1{
      margin:0;
      font-size: 18px;
      letter-spacing: .3px;
    }
    header p{
      margin:8px 0 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.5;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 22px 18px;
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .card .hd{
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.12);
    }
    .card .hd .ttl{
      font-weight: 700;
      font-size: 13px;
      color: #dfe8f6;
      letter-spacing: .2px;
    }
    .card .bd{
      padding: 12px;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }

    input[type="number"], input[type="text"], select{
      background: var(--panel2);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 9px 10px;
      border-radius: 12px;
      outline: none;
      font-size: 13px;
    }
    input[type="number"]{ width: 120px; }
    select{ width: 130px; }

    button{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      transition: .15s transform, .15s background;
      user-select: none;
    }
    button:hover{ background: rgba(255,255,255,.10); }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(103,197,255,.18);
      border-color: rgba(103,197,255,.35);
    }
    button.danger{
      background: rgba(255,107,107,.14);
      border-color: rgba(255,107,107,.28);
    }

    .msg{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,.15);
      border: 1px solid rgba(255,255,255,.06);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.5;
      min-height: 44px;
    }
    .msg.ok{ color: var(--ok); border-color: rgba(139,255,176,.18); }
    .msg.warn{ color: var(--warn); border-color: rgba(255,107,107,.22); }

    .control-grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px){
      .control-grid{ grid-template-columns: 1fr; }
    }

    .rates{
      margin-top: 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 8px;
      max-height: 300px;
      overflow: auto;
      padding-right: 4px;
    }
    .rate-item{
      display: grid;
      grid-template-columns: 44px 1fr 70px;
      gap: 8px;
      align-items: center;
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      padding: 8px 10px;
    }
    .rate-item .idx{
      font-family: var(--mono);
      color: #cfe5ff;
      font-size: 12px;
    }
    .rate-item input{
      width: 100%;
      font-family: var(--mono);
      letter-spacing: .1px;
    }
    .rate-item .hint{
      font-size: 11px;
      color: var(--muted);
      text-align: right;
      font-family: var(--mono);
    }

    .stage{
      padding: 12px;
    }

    .topbar{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .stats{
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-family: var(--mono);
      color: #cfe5ff;
      font-size: 12px;
    }
    .stats .pill{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
    }

    .maxsnap{
      width: 100%;
      margin-top: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.08);
      color: rgba(233,242,255,.85);
    }
    .maxsnap .ttl{
      font-weight: 700;
      font-size: 12px;
      color: #dfe8f6;
      margin-bottom: 6px;
      letter-spacing: .1px;
    }
    .maxsnap .body{
      font-family: var(--mono);
      font-size: 11px;
      line-height: 1.45;
      white-space: pre-wrap;
      color: rgba(233,242,255,.75);
    }

    .cups{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }

    .cup{
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 14px;
      padding: 10px;
      position: relative;
      overflow: hidden;
    }
    .cup .title{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 8px;
      gap: 8px;
    }
    .cup .title .name{
      font-weight: 700;
      font-size: 12px;
      letter-spacing: .1px;
    }
    .cup .title .ai{
      font-family: var(--mono);
      color: #cfe5ff;
      font-size: 12px;
    }

    .glass{
      height: 220px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      position: relative;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.1);
    }

    .ticks{
      position:absolute;
      inset: 10px 10px 10px 10px;
      pointer-events:none;
    }
    .tick{
      position:absolute;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(255,255,255,.07);
    }
    .tick span{
      position:absolute;
      left: 6px;
      top: -9px;
      font-size: 10px;
      color: rgba(233,242,255,.55);
      font-family: var(--mono);
      background: rgba(0,0,0,.18);
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.05);
    }

    .water{
      position:absolute;
      left:0; right:0; bottom:0;
      height: 0%;
      background: linear-gradient(180deg, rgba(103,197,255,.82), rgba(103,197,255,.40));
      box-shadow: inset 0 10px 30px rgba(0,0,0,.15);
      transition: height var(--waterTrans) ease;
      will-change: height;
    }

    .dump-mark{
      position:absolute;
      left:0; right:0;
      height: 2px;
      background: rgba(255, 70, 70, .95);
      box-shadow: 0 0 0 1px rgba(0,0,0,.25), 0 0 12px rgba(255,70,70,.25);
      pointer-events:none;
      opacity: 0;
      transition: opacity .08s linear;
    }

    .cup .foot{
      margin-top: 8px;
      font-family: var(--mono);
      font-size: 12px;
      color: #d7e9ff;
      display:flex;
      justify-content: space-between;
      gap: 8px;
    }
    .cup .foot .muted{
      color: rgba(233,242,255,.65);
    }

    .history{
      margin-top: 10px;
      max-height: 240px;
      overflow: auto;
      padding-right: 4px;
    }
    .hitem{
      border: 1px solid rgba(255,255,255,.06);
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      padding: 8px 10px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    .hitem .hhd{
      display:flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 10px;
      margin-bottom: 4px;
      font-size: 12px;
      color: #dfe8f6;
    }
    .hitem .hbd{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(233,242,255,.70);
      white-space: pre-wrap;
      line-height: 1.35;
    }
  </style>
</head>
<body>
  <header>
    <h1>åˆ†é€Ÿ a_1, a_2, â€¦, a_kï¼ˆåˆè¨ˆ 1ï¼‰ã§æ³¨ãŒã‚Œã‚‹ã‚³ãƒƒãƒ—ã®å¯è¦–åŒ–ï¼ˆå³å¯†è¨ˆç®—ï¼‰</h1>
    <p>
      k å€‹ã®ã‚³ãƒƒãƒ—ã«ã€åˆ†é€Ÿ a_i ãƒªãƒƒãƒˆãƒ«ã§æ³¨ãŒã‚Œã‚‹ã¨ãã®æ°´ä½ã‚’æç”»ã—ã¾ã™ï¼ˆç›®ç››ã‚Šã¤ãã€æ°´è‰²ã®å……å¡«ï¼‰ã€‚
      a_1+â€¦+a_k=1 ã‚’æº€ãŸã™ã‚ˆã†ã«å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆå°æ•°/åˆ†æ•°ã©ã¡ã‚‰ã§ã‚‚OKï¼‰ã€‚Undo/Redo ã¤ãã§ã™ã€‚<br/>
      â˜…å€¤ã®æ›´æ–°ï¼ˆæ³¨ã/åˆ¤å®š/ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ã¯ã€Œt ãŒæ•´æ•°ï¼ˆåˆ†ï¼‰ã€ã®ã¨ãã ã‘è¡Œã„ã¾ã™ï¼ˆé€”ä¸­ã§åˆ»ã¿ã¾ã›ã‚“ï¼‰ã€‚<br/>
      æ¯åˆ† t=1,2,3,â€¦ ã«ã€ã¾ãš 1 åˆ†ã¶ã‚“æ³¨ãã€ãã®ç›´å¾Œã«ã€Œã„ãšã‚Œã‹ã®ã€ã‚³ãƒƒãƒ—ãŒ 2 ã‚’è¶…ãˆãŸã‚‰è‡ªå‹•åœæ­¢ã—ã¾ã™ï¼ˆã¡ã‚‡ã†ã© 2 ã¯OKï¼‰ã€‚
      è‡ªå‹•åœæ­¢ã—ãªã‘ã‚Œã°ã€ãã®åŒã˜åˆ†å¢ƒç•Œã§ã€Œæœ€ã‚‚é‡ãŒå¤šã„ã‚³ãƒƒãƒ—ã€ã‚’ 1ã¤ã ã‘æ¨ã¦ã¦ 0 ã«ã—ã¾ã™ï¼ˆåŒå€¤ãªã‚‰ index ãŒå°ã•ã„æ–¹ï¼‰ã€‚
      æ¨ã¦ãŸç¬é–“ã®æ°´ä½ã«èµ¤ç·šã‚’æ®‹ã—ã€æ¬¡ã®æ¨ã¦ãŒèµ·ãã‚‹ã¾ã§è¡¨ç¤ºã—ã¾ã™ï¼ˆæ¬¡ã®æ¨ã¦ã§èµ¤ç·šã¯å…¥ã‚Œæ›¿ãˆï¼‰ã€‚
      ã•ã‚‰ã«ã€å„ã‚³ãƒƒãƒ—ãŒã“ã‚Œã¾ã§åˆ°é”ã—ãŸã€Œæœ€å¤§æ°´é‡ã€ã¨ã€ãã®æ™‚åˆ»ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚<br/>
      ï¼ˆå†…éƒ¨è¨ˆç®—ã¯ BigInt æœ‰ç†æ•°ã§å³å¯†ï¼‰
      â˜…æ™‚åˆ» t ã¯æ•´æ•°ï¼ˆ0,1,2,3,... åˆ†ï¼‰ã¨ã—ã¦è¡¨ç¤ºã—ã¾ã™ã€‚
    </p>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div class="ttl">æ“ä½œ</div>
        <div style="font-family:var(--mono); font-size:12px; color:rgba(233,242,255,.7)">
          cap ã¯æœ€å¤§ 4L
        </div>
      </div>
      <div class="bd">
        <div class="control-grid">
          <div>
            <div class="row">
              <div>
                <label>ã‚³ãƒƒãƒ—æ•° k</label><br/>
                <select id="kSelect"></select>
              </div>
              <div>
                <label>ã‚³ãƒƒãƒ—å®¹é‡ï¼ˆLï¼‰</label><br/>
                <input id="capInput" type="number" step="0.01" min="0.01" max="4.00" value="4.00" />
              </div>
              <div>
                <label>æ™‚é–“å€ç‡ï¼ˆÃ—ï¼‰</label><br/>
                <input id="speedInput" type="number" step="0.1" min="0.1" value="30.0" />
              </div>
            </div>

            <div class="row">
              <button id="applyBtn" class="primary">a_i ã‚’åæ˜ </button>
              <button id="normalizeBtn">1 ã«æ­£è¦åŒ–</button>
              <button id="randomBtn">ãƒ©ãƒ³ãƒ€ãƒ </button>
            </div>

            <div class="row">
              <button id="startBtn" class="primary">â–¶ é–‹å§‹</button>
              <button id="pauseBtn">â¸ ä¸€æ™‚åœæ­¢</button>
              <button id="resetBtn" class="danger">â†º ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div class="row">
              <button id="undoBtn">â† Undo</button>
              <button id="redoBtn">Redo â†’</button>
              <button id="snapshotBtn">ğŸ“Œ ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ</button>
            </div>

            <div id="msg" class="msg">a_i ã‚’å…¥åŠ›ã—ã¦ã€Œåæ˜ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</div>

            <div style="margin-top:12px; color:var(--muted); font-size:12px; line-height:1.5;">
              ãƒ»å€¤ã®æ›´æ–°ã¯ã€Œ1åˆ†ã”ã¨ï¼ˆt ãŒæ•´æ•°ã®ã¨ãï¼‰ã€ã« 1 å›ã ã‘è¡Œã„ã¾ã™ï¼ˆé€”ä¸­ã§åˆ»ã¿ã¾ã›ã‚“ï¼‰ã€‚<br/>
              ãƒ»æ¯åˆ†ï¼ˆt=1,2,3,â€¦åˆ†åˆ°é”æ™‚ï¼‰ã«ã€æœ€å¤§ã®ã‚³ãƒƒãƒ—ã‚’ 1ã¤ã ã‘æ¨ã¦ã¾ã™ï¼ˆåŒå€¤ãªã‚‰ index ãŒå°ã•ã„æ–¹ï¼‰ã€‚<br/>
              ãƒ»æ™‚é–“å€ç‡ Ã— ã¯ã€Œå®Ÿæ™‚é–“ 1 ç§’ã‚ãŸã‚Šã®ä»®æƒ³ç§’æ•°ã€ã¨ã—ã¦åŠ¹ãã¾ã™ï¼ˆä¾‹ï¼šÃ—30 ã§ 30ç§’/ç§’ï¼‰ã€‚<br/>
              ãƒ»æ¨ã¦ãŸç¬é–“ã®é«˜ã•ã«èµ¤ç·šã‚’è¡¨ç¤ºã—ã€æ¬¡ã®æ¨ã¦ãŒèµ·ããŸã‚‰èµ¤ç·šã‚’å…¥ã‚Œæ›¿ãˆã¾ã™ã€‚<br/>
              ãƒ»å„ã‚³ãƒƒãƒ—ã®ã€Œæœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã€ã¯æ•´æ•° tï¼ˆåˆ†ï¼‰ã§è¨˜éŒ²ã—ã¾ã™ã€‚<br/>
              â˜…ã€Œã„ãšã‚Œã‹ã®ã€ã‚³ãƒƒãƒ—ãŒ 2 ã‚’è¶…ãˆãŸç¬é–“ã«è‡ªå‹•åœæ­¢ã—ã¾ã™ï¼ˆ=2 ã¯OKã€>2 ã‹ã‚‰NGï¼‰ã€‚<br/>
              â˜…å†…éƒ¨ã¯ BigInt æœ‰ç†æ•°ï¼ˆåˆ†æ•°ï¼‰ã§å³å¯†ã«æ¯”è¼ƒã™ã‚‹ã®ã§ã€æµ®å‹•å°æ•°èª¤å·®ã¯åŸå› ã«ãªã‚Šã¾ã›ã‚“ã€‚<br/>
              â˜…t è¡¨ç¤ºã¯æ•´æ•°ã®ã¿ï¼ˆåœæ­¢æ™‚ã‚‚æ•´æ•° t ã‚’è¡¨ç¤ºï¼‰ã€‚
            </div>
          </div>

          <div>
            <div style="display:flex; align-items:baseline; justify-content:space-between; margin-bottom:8px;">
              <div style="font-weight:700; font-size:13px; color:#dfe8f6;">a_i å…¥åŠ›</div>
              <div style="font-family:var(--mono); font-size:12px; color:rgba(233,242,255,.7);">
                Î£ a_i = <span id="sumLabel">0.000000</span>
              </div>
            </div>
            <div class="rates" id="rates"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div class="ttl">å®Ÿè¡ŒçŠ¶æ³</div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span style="font-family:var(--mono); font-size:12px; color:rgba(233,242,255,.7)">å±¥æ­´</span>
        </div>
      </div>
      <div class="bd stage">
        <div class="topbar">
          <div class="stats">
            <div class="pill">t = <span id="timeLabel">0</span> min</div>
            <div class="pill">å®¹é‡ = <span id="capLabel">4.00</span> L</div>
            <div class="pill">æ¬¡ã®æ›´æ–°ã¾ã§: <span id="nextTickLabel">2.00</span>sï¼ˆå®Ÿï¼‰</div>
            <div class="pill">æ¬¡ã®æ¨ã¦: <span id="nextDumpLabel">1</span> min</div>
          </div>

          <div style="min-width: 340px;">
            <div class="stats">
              <div class="pill">çŠ¶æ…‹: <span id="stateLabel">åœæ­¢</span></div>
              <div class="pill">ç›´è¿‘ã®æ¨ã¦: <span id="lastDumpLabel">-</span></div>
            </div>

            <div class="maxsnap" id="maxSnapBox">
              <div class="ttl">æœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆå„ã‚³ãƒƒãƒ—ãŒåˆ°é”ã—ãŸæœ€å¤§ï¼‰</div>
              <div class="body" id="maxSnapBody">-</div>
            </div>
          </div>
        </div>

        <div class="cups" id="cups"></div>
        <div class="history" id="history"></div>
      </div>
    </div>
  </div>

  <script>
    // ========= ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆè¡¨ç¤ºç”¨ï¼‰ =========
    const clampNum = (x, a, b) => Math.max(a, Math.min(b, x));
    const fmt = (x, d=3) => (Number.isFinite(x) ? x.toFixed(d) : "NaN");
    const nowStr = () => {
      const d = new Date();
      const pad = (n) => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    };

    // ========= BigInt æœ‰ç†æ•°ï¼ˆSymPyã®Rationalã£ã½ã„æœ€å°å®Ÿè£…ï¼‰ =========
    const absBI = (x) => (x < 0n ? -x : x);
    const gcdBI = (a, b) => {
      a = absBI(a); b = absBI(b);
      while (b !== 0n) { const t = a % b; a = b; b = t; }
      return a;
    };
    const pow10BI = (n) => {
      let r = 1n;
      for (let i=0; i<n; i++) r *= 10n;
      return r;
    };

    class Frac {
      constructor(n, d=1n){
        if (d === 0n) throw new Error("Frac: division by zero");
        if (d < 0n){ n = -n; d = -d; }
        if (n === 0n){ this.n = 0n; this.d = 1n; return; }
        const g = gcdBI(n, d);
        this.n = n / g;
        this.d = d / g;
      }
      static ZERO(){ return new Frac(0n,1n); }
      static ONE(){ return new Frac(1n,1n); }

      add(o){ return new Frac(this.n*o.d + o.n*this.d, this.d*o.d); }
      sub(o){ return new Frac(this.n*o.d - o.n*this.d, this.d*o.d); }
      mul(o){ return new Frac(this.n*o.n, this.d*o.d); }
      div(o){
        if (o.n === 0n) throw new Error("Frac: division by zero");
        return new Frac(this.n*o.d, this.d*o.n);
      }
      cmp(o){
        const L = this.n*o.d;
        const R = o.n*this.d;
        return (L < R) ? -1 : (L > R ? 1 : 0);
      }
      toNumber(){ return Number(this.n) / Number(this.d); }
      toFracString(){
        if (this.d === 1n) return this.n.toString();
        return `${this.n.toString()}/${this.d.toString()}`;
      }
      static fromString(raw){
        let s = String(raw).trim();
        if (s === "") return null;
        s = s.replace(/,/g,"");

        if (s.includes("/")){
          const parts = s.split("/");
          if (parts.length !== 2) return null;
          const a = parts[0].trim();
          const b = parts[1].trim();
          if (!/^[+-]?\d+$/.test(a) || !/^[+-]?\d+$/.test(b)) return null;
          const n = BigInt(a);
          const d = BigInt(b);
          if (d === 0n) return null;
          return new Frac(n, d);
        }

        const m = s.match(/^([+-]?)(\d*)(?:\.(\d*))?(?:[eE]([+-]?\d+))?$/);
        if (!m) return null;

        const sign = (m[1] === "-") ? -1n : 1n;
        const intPart = (m[2] && m[2].length ? m[2] : "0");
        const fracPart = (m[3] && m[3].length ? m[3] : "");
        const expPart = (m[4] ? parseInt(m[4], 10) : 0);

        const digits = (intPart + fracPart).replace(/^0+(?=\d)/,"") || "0";
        let n = BigInt(digits);
        let d = pow10BI(fracPart.length);

        if (expPart > 0){
          n *= pow10BI(expPart);
        } else if (expPart < 0){
          d *= pow10BI(-expPart);
        }
        n *= sign;
        return new Frac(n, d);
      }
    }

    const fracClamp = (x, lo, hi) => {
      if (x.cmp(lo) < 0) return lo;
      if (x.cmp(hi) > 0) return hi;
      return x;
    };

    // ========= DOM =========
    const kSelect = document.getElementById("kSelect");
    const capInput = document.getElementById("capInput");
    const speedInput = document.getElementById("speedInput");
    const ratesDiv = document.getElementById("rates");
    const cupsDiv = document.getElementById("cups");
    const msgDiv = document.getElementById("msg");

    const timeLabel = document.getElementById("timeLabel");
    const sumLabel = document.getElementById("sumLabel");
    const capLabel = document.getElementById("capLabel");
    const stateLabel = document.getElementById("stateLabel");
    const nextTickLabel = document.getElementById("nextTickLabel");
    const nextDumpLabel = document.getElementById("nextDumpLabel");
    const lastDumpLabel = document.getElementById("lastDumpLabel");

    const maxSnapBody = document.getElementById("maxSnapBody");
    const historyDiv = document.getElementById("history");

    // ========= çŠ¶æ…‹ï¼ˆå³å¯†ï¼šFracï¼‰ =========
    let k = 4;

    let capR = Frac.fromString("4.0");     // Lï¼ˆæœ€å¤§ 4ï¼‰
    let speed = 30.0;                     // å®Ÿ1ç§’ã‚ãŸã‚Šã®ä»®æƒ³ç§’ï¼ˆfloatã§OKï¼‰

    let aR = []; // L/minï¼ˆå³å¯†ï¼‰
    let vR = []; // Lï¼ˆå³å¯†ï¼‰

    // â˜…æ™‚åˆ» t ã¯ã€Œæ•´æ•°åˆ†ã€ã ã‘ç®¡ç†ã™ã‚‹ï¼ˆ0,1,2,...ï¼‰
    let tInt = 0;

    let running = false;

    // â˜…ã€Œå€¤ã‚’å¯ç®—ã™ã‚‹ã®ã¯æ•´æ•° t ã ã‘ã€â†’ æ›´æ–°ã¯ 60ç§’ï¼ˆä»®æƒ³ï¼‰ã”ã¨ï¼1åˆ†åˆ»ã¿
    const TICK_SIM_SEC = 60;                   // 1åˆ†ï¼ˆä»®æƒ³ï¼‰
    const DT_MIN_R = new Frac(1n, 1n);         // 1åˆ†ï¼ˆå³å¯†ï¼‰

    let accSimSec = 0.0;

    // èµ¤ç·šï¼ˆç›´è¿‘ã®æ¨ã¦ï¼‰
    let dumpMarkIdx = -1;
    let dumpMarkVolR = Frac.ZERO();

    // æœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆæ™‚åˆ»ã¯æ•´æ•° t ã§è¨˜éŒ²ï¼‰
    let maxVR = [];
    let maxTInt = [];
    let maxDump = [];

    // â˜…è‡ªå‹•åœæ­¢æ¡ä»¶ï¼šv[i] > 2 ãŒ1å€‹ã§ã‚‚ã‚ã‚Œã°åœæ­¢ï¼ˆ=2ã¯OKï¼‰
    const THRESH_STOP_R = new Frac(2n, 1n);

    // Undo/Redo
    const HISTORY_MAX = 200;
    let hist = [];
    let histIndex = -1;

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let lastTs = null;

    // æç”»ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    const domCache = { water: [], vol: [], pct: [], ai: [], mark: [] };

    // ========= åˆæœŸåŒ– =========
    for (let i=1; i<=100; i++){
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = i;
      if (i === k) opt.selected = true;
      kSelect.appendChild(opt);
    }

    function setMsg(text, kind){
      msgDiv.textContent = text;
      msgDiv.classList.remove("ok","warn");
      if (kind === "ok") msgDiv.classList.add("ok");
      if (kind === "warn") msgDiv.classList.add("warn");
    }

    function initState(newK){
      k = newK;

      // åˆæœŸ a_i = 1/k ã‚’å³å¯†ã«
      aR = Array.from({length:k}, ()=> new Frac(1n, BigInt(k)));
      vR = Array.from({length:k}, ()=> Frac.ZERO());

      // â˜…æ•´æ•°æ™‚åˆ»
      tInt = 0;

      running = false;
      lastTs = null;
      accSimSec = 0.0;

      lastDumpLabel.textContent = "-";

      dumpMarkIdx = -1;
      dumpMarkVolR = Frac.ZERO();

      maxVR = Array.from({length:k}, ()=> Frac.ZERO());
      maxTInt = Array.from({length:k}, ()=> 0);
      maxDump = Array.from({length:k}, ()=> "-");

      rebuildRateInputs();
      rebuildCups();
      updateUI();
      pushHistory("åˆæœŸåŒ–");
      setMsg("a_i ã‚’å…¥åŠ›ã—ã¦ã€Œåæ˜ ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", "");
    }

    function rebuildRateInputs(){
      ratesDiv.innerHTML = "";
      for (let i=0; i<k; i++){
        const item = document.createElement("div");
        item.className = "rate-item";

        const idx = document.createElement("div");
        idx.className = "idx";
        idx.textContent = `a_${i+1}`;

        const inp = document.createElement("input");
        inp.type = "text";
        inp.value = aR[i].toFracString();
        inp.dataset.index = String(i);
        inp.placeholder = "ä¾‹: 0.25  /  1/4";
        inp.addEventListener("input", () => updateSumPreview());

        const hint = document.createElement("div");
        hint.className = "hint";
        hint.textContent = "L/min";

        item.appendChild(idx);
        item.appendChild(inp);
        item.appendChild(hint);
        ratesDiv.appendChild(item);
      }
      updateSumPreview();
    }

    function rebuildCups(){
      cupsDiv.innerHTML = "";
      domCache.water = [];
      domCache.vol = [];
      domCache.pct = [];
      domCache.ai = [];
      domCache.mark = [];

      const capNum = capR.toNumber();

      for (let i=0; i<k; i++){
        const cup = document.createElement("div");
        cup.className = "cup";

        const title = document.createElement("div");
        title.className = "title";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = `Cup ${i+1}`;

        const ai = document.createElement("div");
        ai.className = "ai";
        ai.textContent = `a_${i+1}=${fmt(aR[i].toNumber(),6)}`;
        domCache.ai[i] = ai;

        title.appendChild(name);
        title.appendChild(ai);

        const glass = document.createElement("div");
        glass.className = "glass";

        const water = document.createElement("div");
        water.className = "water";
        domCache.water[i] = water;

        const mark = document.createElement("div");
        mark.className = "dump-mark";
        mark.style.bottom = "0%";
        domCache.mark[i] = mark;

        glass.appendChild(water);
        glass.appendChild(mark);

        const ticks = document.createElement("div");
        ticks.className = "ticks";
        const perc = [0,25,50,75,100];
        for (const p of perc){
          const tk = document.createElement("div");
          tk.className = "tick";
          tk.style.bottom = `calc(${p}% - 0.5px)`;
          const sp = document.createElement("span");
          sp.textContent = `${(capNum*(p/100)).toFixed(2)}L`;
          tk.appendChild(sp);
          ticks.appendChild(tk);
        }
        glass.appendChild(ticks);

        const foot = document.createElement("div");
        foot.className = "foot";

        const vol = document.createElement("div");
        vol.textContent = `${fmt(vR[i].toNumber(),3)} L`;
        domCache.vol[i] = vol;

        const pct = document.createElement("div");
        pct.className = "muted";
        const pnum = clampNum(vR[i].toNumber()/capNum, 0, 1);
        pct.textContent = `${fmt(pnum*100,1)} %`;
        domCache.pct[i] = pct;

        foot.appendChild(vol);
        foot.appendChild(pct);

        cup.appendChild(title);
        cup.appendChild(glass);
        cup.appendChild(foot);
        cupsDiv.appendChild(cup);
      }

      renderDumpMark();
    }

    function readInputsToAFrac(){
      const inputs = ratesDiv.querySelectorAll("input");
      const next = Array.from({length:k}, ()=> Frac.ZERO());
      for (const inp of inputs){
        const i = Number(inp.dataset.index);
        const s = inp.value.trim();
        const f = Frac.fromString(s);
        if (!f) return { ok:false, err:`a_${i+1} ãŒæ•°å€¤ï¼ˆå°æ•°/åˆ†æ•°ï¼‰ã¨ã—ã¦è§£é‡ˆã§ãã¾ã›ã‚“: "${inp.value}"` };
        if (f.cmp(Frac.ZERO()) < 0) return { ok:false, err:`a_${i+1} ã¯è² ã«ã§ãã¾ã›ã‚“ï¼ˆ${inp.value}ï¼‰` };
        next[i] = f;
      }
      return { ok:true, a: next };
    }

    function sumAFrac(arr){
      let s = Frac.ZERO();
      for (const x of arr) s = s.add(x);
      return s;
    }

    function updateSumPreview(){
      const r = readInputsToAFrac();
      if (!r.ok){
        sumLabel.textContent = "NaN";
        return;
      }
      sumLabel.textContent = fmt(sumAFrac(r.a).toNumber(), 6);
    }

    function validateAFrac(arr){
      const s = sumAFrac(arr);
      if (s.cmp(Frac.ONE()) !== 0){
        return { ok:false, err:`Î£ a_i = ${fmt(s.toNumber(),9)} ã§ã™ã€‚å³å¯†ã« 1 ã«ãªã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼ˆã¾ãŸã¯ã€Œ1 ã«æ­£è¦åŒ–ã€ï¼‰ã€‚` };
      }
      for (const x of arr){
        if (x.cmp(Frac.ZERO()) < 0) return { ok:false, err:`a_i ã«è² ã®å€¤ãŒã‚ã‚Šã¾ã™ã€‚` };
      }
      return { ok:true };
    }

    function renderDumpMark(){
      for (let i=0; i<k; i++){
        if (domCache.mark[i]) domCache.mark[i].style.opacity = "0";
      }
      if (dumpMarkIdx >= 0 && dumpMarkIdx < k && domCache.mark[dumpMarkIdx]){
        const p = dumpMarkVolR.div(capR).toNumber();
        const pp = clampNum(p, 0, 1);
        domCache.mark[dumpMarkIdx].style.bottom = `${pp*100}%`;
        domCache.mark[dumpMarkIdx].style.opacity = "1";
      }
    }

    function setDumpMark(idx, volBeforeDumpR){
      dumpMarkIdx = idx;
      dumpMarkVolR = volBeforeDumpR;
      renderDumpMark();
    }

    function clearDumpMark(){
      dumpMarkIdx = -1;
      dumpMarkVolR = Frac.ZERO();
      renderDumpMark();
    }

    // ======== æœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼ˆæ™‚åˆ»ã¯æ•´æ•° tï¼‰ ========
    function updateMaxSnapshots(){
      // â˜…å‘¼ã¶ã®ã¯ã€Œt ãŒæ•´æ•°ã®ã¨ãã€ã ã‘ï¼ˆ= åˆ†æ›´æ–°ã®ç›´å¾Œï¼‰
      for (let i=0; i<k; i++){
        if (vR[i].cmp(maxVR[i]) > 0){
          maxVR[i] = vR[i];
          maxTInt[i] = tInt;
          maxDump[i] = lastDumpLabel.textContent || "-";
        }
      }
    }

    function renderMaxSnapshots(){
      const lines = [];
      for (let i=0; i<k; i++){
        lines.push(
          `Cup ${i+1}: max=${fmt(maxVR[i].toNumber(),3)} L @ t=${maxTInt[i]} min (lastDump=${maxDump[i]})`
        );
      }
      maxSnapBody.textContent = lines.join("\n");
    }

    // ======== â˜…è‡ªå‹•åœæ­¢åˆ¤å®šï¼ˆå³å¯†ï¼š>2 ãŒ1å€‹ã§ã‚‚ã€ãŸã ã—æ•´æ•° t ã®æ›´æ–°ç›´å¾Œã®ã¿å‘¼ã¶ï¼‰ ========
    function findOverTwoStrictExact(){
      const idxs = [];
      for (let i=0; i<k; i++){
        if (vR[i].cmp(THRESH_STOP_R) > 0){
          idxs.push(i);
        }
      }
      return { cnt: idxs.length, idxs };
    }

    function autoPauseIfAnyOverTwoExact(){
      const r = findOverTwoStrictExact();
      if (r.cnt >= 1){
        running = false;
        lastTs = null;
        updateUI();
        pushHistory("è‡ªå‹•ä¸€æ™‚åœæ­¢ï¼ˆ>2 ãŒç™ºç”Ÿãƒ»å³å¯†åˆ¤å®šãƒ»æ•´æ•°tã®ã¿ï¼‰");
        const cups = r.idxs.map(i => `Cup ${i+1}=${fmt(vR[i].toNumber(),3)}L`).join(", ");
        setMsg(`è‡ªå‹•åœæ­¢: t=${tInt} ã®æ™‚ç‚¹ã§ã€2 ã‚’è¶…ãˆãŸã‚³ãƒƒãƒ—ãŒã‚ã‚Šã¾ã™ï¼ˆ${cups}ï¼‰ã€‚`, "warn");
        return true;
      }
      return false;
    }

    function updateUI(){
      capLabel.textContent = Number(capR.toNumber()).toFixed(2);

      // â˜…æ™‚åˆ»ã¯æ•´æ•°ã®ã¿
      timeLabel.textContent = String(tInt);

      stateLabel.textContent = running ? "å®Ÿè¡Œä¸­" : "åœæ­¢";

      // â˜…æ¬¡ã®æ¨ã¦ã¯ tInt+1 åˆ†
      nextDumpLabel.textContent = String(tInt + 1);

      const sp = Math.max(speed, 1e-9);
      const remSim = Math.max(0, TICK_SIM_SEC - accSimSec);
      const remReal = remSim / sp;
      nextTickLabel.textContent = remReal.toFixed(2);

      const tickReal = TICK_SIM_SEC / sp; // 1åˆ†ã¶ã‚“ã®æ›´æ–°ã«åˆã‚ã›ã‚‹
      const dur = clampNum(tickReal * 0.85, 0.02, 0.25);
      document.documentElement.style.setProperty("--waterTrans", `${dur.toFixed(3)}s`);

      for (let i=0; i<k; i++){
        if (domCache.ai[i]) domCache.ai[i].textContent = `a_${i+1}=${fmt(aR[i].toNumber(),6)}`;
      }

      const capNum = capR.toNumber();
      for (let i=0; i<k; i++){
        const w = domCache.water[i];
        if (!w) continue;
        const p = clampNum(vR[i].toNumber()/capNum, 0, 1);
        w.style.height = `${p*100}%`;
        if (domCache.vol[i]) domCache.vol[i].textContent = `${fmt(vR[i].toNumber(),3)} L`;
        if (domCache.pct[i]) domCache.pct[i].textContent = `${fmt(p*100,1)} %`;
      }

      sumLabel.textContent = fmt(sumAFrac(aR).toNumber(), 6);
      renderDumpMark();
      renderMaxSnapshots();
    }

    // ========= ã€Œæ¨ã¦ã€ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå³å¯†æ¯”è¼ƒï¼‰ =========
    function dumpOne(){
      let bestIdx = 0;
      let bestVal = vR[0];
      for (let i=1; i<k; i++){
        if (vR[i].cmp(bestVal) > 0){
          bestVal = vR[i];
          bestIdx = i;
        } else if (vR[i].cmp(bestVal) === 0){
          // åŒå€¤ãªã‚‰ index ãŒå°ã•ã„æ–¹ï¼ˆbestIdxãã®ã¾ã¾ï¼‰
        }
      }

      const volBefore = vR[bestIdx];
      setDumpMark(bestIdx, volBefore);

      vR[bestIdx] = Frac.ZERO();
      lastDumpLabel.textContent = `Cup ${bestIdx+1}`;
      pushHistory(`æ¨ã¦: Cup ${bestIdx+1}`);
      setMsg(`æ¯åˆ†å‡¦ç†(t=${tInt}): æœ€å¤šã® Cup ${bestIdx+1} ã‚’æ¨ã¦ã¦ 0 ã«ã—ã¾ã—ãŸï¼ˆèµ¤ç·šï¼æ¨ã¦ãŸç¬é–“ã®é«˜ã•ï¼‰ã€‚`, "ok");
    }

    // ========= ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ•´æ•° t ã®ã¨ãã ã‘æ›´æ–°ï¼‰ =========
    function step(ts){
      if (!running){
        lastTs = null;
        return;
      }
      if (lastTs == null) lastTs = ts;

      const dtRealSec = (ts - lastTs) / 1000.0;
      lastTs = ts;

      accSimSec += dtRealSec * speed;

      // â˜…1åˆ†(=60ç§’ä»®æƒ³)ã”ã¨ã«ã ã‘æ›´æ–°ã™ã‚‹
      while (accSimSec >= TICK_SIM_SEC){
        accSimSec -= TICK_SIM_SEC;

        // 1åˆ†ã¶ã‚“æ³¨ãï¼ˆå³å¯†ï¼‰
        for (let i=0; i<k; i++){
          vR[i] = vR[i].add(aR[i].mul(DT_MIN_R)); // DT=1åˆ†
          vR[i] = fracClamp(vR[i], Frac.ZERO(), capR);
        }

        // â˜…åˆ†å¢ƒç•Œã§æ•´æ•°æ™‚åˆ»ã‚’ +1ï¼ˆt=1,2,3,...ï¼‰
        tInt++;

        // â˜…æœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ›´æ–°ï¼ˆæ•´æ•° t ã®ã¨ãã ã‘ï¼‰
        updateMaxSnapshots();

        // â˜…ã€Œã„ãšã‚Œã‹ãŒ >2ã€ãªã‚‰å³åœæ­¢ï¼ˆã“ã®åˆ†ã®æ¨ã¦ã‚ˆã‚Šå‰ï¼‰
        if (autoPauseIfAnyOverTwoExact()){
          return;
        }

        // åˆ†å¢ƒç•Œã§ã€Œ1å›ã ã‘ã€æ¨ã¦ã‚‹
        dumpOne();
      }

      updateUI();
      requestAnimationFrame(step);
    }

    // ========= å±¥æ­´ï¼ˆUndo/Redoï¼‰ =========
    function snapshot(){
      return {
        k,
        capR: capR.toFracString(),
        speed,
        aR: aR.map(x => x.toFracString()),
        vR: vR.map(x => x.toFracString()),

        // â˜…æ•´æ•°æ™‚åˆ»ã®ã¿
        tInt,

        running: false,
        accSimSec,

        lastDump: lastDumpLabel.textContent,
        dumpMarkIdx,
        dumpMarkVolR: dumpMarkVolR.toFracString(),

        maxVR: maxVR.map(x => x.toFracString()),
        maxTInt: maxTInt.slice(),
        maxDump: maxDump.slice()
      };
    }

    function applySnapshot(s){
      k = s.k;

      capR = Frac.fromString(s.capR) || Frac.fromString("4.0");
      speed = s.speed;

      aR = (Array.isArray(s.aR) ? s.aR.map(x => Frac.fromString(x)).map(f => f || Frac.ZERO()) : Array.from({length:k}, ()=> new Frac(1n, BigInt(k))));
      vR = (Array.isArray(s.vR) ? s.vR.map(x => Frac.fromString(x)).map(f => f || Frac.ZERO()) : Array.from({length:k}, ()=> Frac.ZERO()));

      // â˜…æ•´æ•°æ™‚åˆ»ã®ã¿
      tInt = Number.isFinite(s.tInt) ? s.tInt : 0;

      running = false;
      lastTs = null;

      accSimSec = s.accSimSec ?? 0.0;
      lastDumpLabel.textContent = s.lastDump ?? "-";

      dumpMarkIdx = (Number.isFinite(s.dumpMarkIdx) ? s.dumpMarkIdx : -1);
      dumpMarkVolR = Frac.fromString(s.dumpMarkVolR) || Frac.ZERO();

      if (Array.isArray(s.maxVR) && s.maxVR.length === k){
        maxVR = s.maxVR.map(x => Frac.fromString(x)).map(f => f || Frac.ZERO());
        maxTInt = (Array.isArray(s.maxTInt) ? s.maxTInt.slice() : Array.from({length:k}, ()=> 0));
        maxDump = (Array.isArray(s.maxDump) ? s.maxDump.slice() : Array.from({length:k}, ()=> "-"));
      } else {
        maxVR = Array.from({length:k}, ()=> Frac.ZERO());
        maxTInt = Array.from({length:k}, ()=> 0);
        maxDump = Array.from({length:k}, ()=> "-");
      }

      kSelect.value = String(k);
      capInput.value = String(capR.toNumber());
      speedInput.value = String(speed);

      rebuildRateInputs();
      rebuildCups();
      updateUI();
    }

    function pushHistory(action){
      const s = snapshot();

      if (histIndex < hist.length - 1){
        hist.splice(histIndex + 1);
      }
      hist.push({ action, time: nowStr(), state: s });
      if (hist.length > HISTORY_MAX){
        hist.shift();
      }
      histIndex = hist.length - 1;
      renderHistory();
    }

    function undo(){
      if (histIndex <= 0){
        setMsg("ã“ã‚Œä»¥ä¸Š Undo ã§ãã¾ã›ã‚“ã€‚", "warn");
        return;
      }
      histIndex--;
      applySnapshot(hist[histIndex].state);
      setMsg(`Undo: ${hist[histIndex].action}`, "ok");
      renderHistory();
    }

    function redo(){
      if (histIndex >= hist.length - 1){
        setMsg("ã“ã‚Œä»¥ä¸Š Redo ã§ãã¾ã›ã‚“ã€‚", "warn");
        return;
      }
      histIndex++;
      applySnapshot(hist[histIndex].state);
      setMsg(`Redo: ${hist[histIndex].action}`, "ok");
      renderHistory();
    }

    function renderHistory(){
      historyDiv.innerHTML = "";
      for (let i = hist.length - 1; i >= 0; i--){
        const h = hist[i];
        const item = document.createElement("div");
        item.className = "hitem";
        if (i === histIndex){
          item.style.borderColor = "rgba(103,197,255,.35)";
          item.style.background = "rgba(103,197,255,.08)";
        }

        const hhd = document.createElement("div");
        hhd.className = "hhd";
        const left = document.createElement("div");
        left.textContent = `#${i+1} ${h.action}`;
        const right = document.createElement("div");
        right.style.color = "rgba(233,242,255,.65)";
        right.style.fontFamily = "var(--mono)";
        right.textContent = h.time;
        hhd.appendChild(left);
        hhd.appendChild(right);

        const hbd = document.createElement("div");
        hbd.className = "hbd";
        const s = h.state;

        const sumA = sumAFrac((s.aR || []).map(x => Frac.fromString(x)).map(f => f || Frac.ZERO()));
        const aNums = (s.aR || []).map(x => (Frac.fromString(x)||Frac.ZERO()).toNumber().toFixed(6));
        const vNums = (s.vR || []).map(x => (Frac.fromString(x)||Frac.ZERO()).toNumber().toFixed(3));

        const dmIdx = s.dumpMarkIdx ?? -1;
        const dmVol = Frac.fromString(s.dumpMarkVolR || "0") || Frac.ZERO();

        hbd.textContent =
`k=${s.k}, cap=${(Frac.fromString(s.capR)||Frac.ZERO()).toNumber().toFixed(2)}L, speed=${Number(s.speed).toFixed(2)}x, t=${Number.isFinite(s.tInt)?s.tInt:0}min
sum(a)=${sumA.toNumber().toFixed(9)}
nextDumpAt=${(Number.isFinite(s.tInt)?s.tInt:0)+1}min, lastDump=${s.lastDump ?? "-"}
dumpMark=${dmIdx >= 0 ? `Cup ${dmIdx+1} @ ${dmVol.toNumber().toFixed(3)}L` : "-"}
a=[${aNums.join(", ")}]
v=[${vNums.join(", ")}]`;

        item.appendChild(hhd);
        item.appendChild(hbd);

        item.addEventListener("click", () => {
          histIndex = i;
          applySnapshot(hist[histIndex].state);
          setMsg(`å±¥æ­´ã«ç§»å‹•: #${i+1} ${hist[histIndex].action}`, "ok");
          renderHistory();
        });

        historyDiv.appendChild(item);
      }
    }

    // ========= ã‚¤ãƒ™ãƒ³ãƒˆ =========
    kSelect.addEventListener("change", () => {
      const newK = Number(kSelect.value);
      initState(newK);
    });

    capInput.addEventListener("change", () => {
      let x = Number(capInput.value);
      if (!Number.isFinite(x) || x <= 0){
        setMsg("å®¹é‡ã¯æ­£ã®æ•°ã«ã—ã¦ãã ã•ã„ã€‚", "warn");
        capInput.value = String(capR.toNumber());
        return;
      }
      if (x > 4.0) x = 4.0;

      const f = Frac.fromString(String(x));
      if (!f){
        setMsg("å®¹é‡ãŒè§£é‡ˆã§ãã¾ã›ã‚“ã€‚", "warn");
        capInput.value = String(capR.toNumber());
        return;
      }
      capR = f;
      capInput.value = String(capR.toNumber());

      for (let i=0; i<k; i++){
        vR[i] = fracClamp(vR[i], Frac.ZERO(), capR);
        if (maxVR[i].cmp(capR) > 0) maxVR[i] = capR;
      }

      rebuildCups();
      updateUI();
      pushHistory("å®¹é‡å¤‰æ›´");
      setMsg("å®¹é‡ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚", "ok");
    });

    speedInput.addEventListener("change", () => {
      const x = Number(speedInput.value);
      if (!Number.isFinite(x) || x <= 0){
        setMsg("æ™‚é–“å€ç‡ã¯æ­£ã®æ•°ã«ã—ã¦ãã ã•ã„ã€‚", "warn");
        speedInput.value = String(speed);
        return;
      }
      speed = x;
      updateUI();
      pushHistory("æ™‚é–“å€ç‡å¤‰æ›´");
      setMsg("æ™‚é–“å€ç‡ã‚’å¤‰æ›´ã—ã¾ã—ãŸã€‚", "ok");
    });

    document.getElementById("applyBtn").addEventListener("click", () => {
      const r = readInputsToAFrac();
      if (!r.ok){
        setMsg(r.err, "warn");
        return;
      }
      const vr = validateAFrac(r.a);
      if (!vr.ok){
        setMsg(vr.err, "warn");
        return;
      }
      aR = r.a.slice();
      updateUI();
      pushHistory("a_i åæ˜ ");
      setMsg("a_i ã‚’åæ˜ ã—ã¾ã—ãŸï¼ˆÎ£a_i=1ãƒ»å³å¯†ï¼‰ã€‚", "ok");
    });

    document.getElementById("normalizeBtn").addEventListener("click", () => {
      const r = readInputsToAFrac();
      if (!r.ok){
        setMsg(r.err, "warn");
        return;
      }
      const s = sumAFrac(r.a);
      if (s.cmp(Frac.ZERO()) <= 0){
        setMsg("åˆè¨ˆãŒ 0 ãªã®ã§æ­£è¦åŒ–ã§ãã¾ã›ã‚“ã€‚", "warn");
        return;
      }
      aR = r.a.map(x => x.div(s)); // å³å¯†æ­£è¦åŒ–ï¼ˆÎ£=1ï¼‰

      const inputs = ratesDiv.querySelectorAll("input");
      inputs.forEach(inp => {
        const i = Number(inp.dataset.index);
        inp.value = aR[i].toFracString();
      });

      updateUI();
      pushHistory("1 ã«æ­£è¦åŒ–ï¼ˆå³å¯†ï¼‰");
      setMsg("a_i ã‚’åˆè¨ˆ 1 ã«ãªã‚‹ã‚ˆã†ã«å³å¯†ã«æ­£è¦åŒ–ã—ã¾ã—ãŸã€‚", "ok");
    });

    document.getElementById("randomBtn").addEventListener("click", () => {
      const ints = Array.from({length:k}, ()=> BigInt(Math.floor(Math.random()*1000000) + 1));
      let sum = 0n;
      for (const x of ints) sum += x;

      aR = ints.map(x => new Frac(x, sum)); // Î£=1 ã‚’å³å¯†ã«

      const inputs = ratesDiv.querySelectorAll("input");
      inputs.forEach(inp => {
        const i = Number(inp.dataset.index);
        inp.value = aR[i].toFracString();
      });

      updateUI();
      pushHistory("ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼ˆå³å¯†ï¼‰");
      setMsg("ãƒ©ãƒ³ãƒ€ãƒ ãª a_i ã‚’å³å¯†ã«ç”Ÿæˆã—ã¾ã—ãŸï¼ˆÎ£a_i=1ï¼‰ã€‚", "ok");
    });

    document.getElementById("startBtn").addEventListener("click", () => {
      const vr = validateAFrac(aR);
      if (!vr.ok){
        setMsg(vr.err, "warn");
        return;
      }
      if (running) return;
      running = true;
      lastTs = null;

      // â˜…é–‹å§‹æ™‚ç‚¹(t=0)ã§ã¯ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆæ›´æ–°ã—ãªã„ï¼ˆã€Œæ•´æ•°tã®æ›´æ–°ã‚¿ã‚¤ãƒŸãƒ³ã‚°=åˆ†æ›´æ–°ç›´å¾Œã€ã«çµ±ä¸€ï¼‰
      updateUI();
      pushHistory("é–‹å§‹");
      setMsg("å®Ÿè¡Œä¸­ã§ã™ï¼ˆæ›´æ–°/åˆ¤å®šã¯æ•´æ•° t ã®ã¨ãã ã‘ã€‚ã„ãšã‚Œã‹ãŒ >2 ãªã‚‰è‡ªå‹•åœæ­¢ãƒ»å³å¯†åˆ¤å®šï¼‰ã€‚", "ok");
      requestAnimationFrame(step);
    });

    document.getElementById("pauseBtn").addEventListener("click", () => {
      if (!running){
        setMsg("ã™ã§ã«åœæ­¢ã—ã¦ã„ã¾ã™ã€‚", "warn");
        return;
      }
      running = false;
      updateUI();
      pushHistory("ä¸€æ™‚åœæ­¢");
      setMsg(`åœæ­¢ã—ã¾ã—ãŸï¼ˆt=${tInt}ï¼‰ã€‚`, "ok");
    });

    document.getElementById("resetBtn").addEventListener("click", () => {
      running = false;
      lastTs = null;

      // â˜…æ•´æ•°æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ
      tInt = 0;

      vR = Array.from({length:k}, ()=> Frac.ZERO());

      accSimSec = 0.0;
      lastDumpLabel.textContent = "-";

      clearDumpMark();

      maxVR = Array.from({length:k}, ()=> Frac.ZERO());
      maxTInt = Array.from({length:k}, ()=> 0);
      maxDump = Array.from({length:k}, ()=> "-");

      updateUI();
      pushHistory("ãƒªã‚»ãƒƒãƒˆ");
      setMsg("æ°´é‡ã¨æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸï¼ˆæœ€å¤§æ°´é‡ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚‚ãƒªã‚»ãƒƒãƒˆï¼‰ã€‚", "ok");
    });

    document.getElementById("undoBtn").addEventListener("click", undo);
    document.getElementById("redoBtn").addEventListener("click", redo);

    document.getElementById("snapshotBtn").addEventListener("click", () => {
      pushHistory("ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ");
      setMsg("ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚", "ok");
    });

    // ========= èµ·å‹• =========
    initState(k);
  </script>
</body>
</html>